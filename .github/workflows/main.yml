name: main

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  check:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Create venv and install dev dependencies
        run: |
          just create cpy311
          just install-dev cpy311

      - name: Run code quality checks
        run: just check cpy311
        continue-on-error: true  # Don't fail build on type/format errors yet

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04]
        # Note: pypy311 excluded because zlmdb v25.10.1 lacks PyPy wheels on PyPI
        env: ['cpy311', 'cpy312', 'cpy313', 'cpy314']

    continue-on-error: false

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Create venv and install dependencies
        run: |
          just create ${{ matrix.env }}
          just install-dev ${{ matrix.env }}

      - name: Run tests
        run: just test ${{ matrix.env }}

  docs:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Create venv and install dependencies
        run: |
          just create cpy311
          just install-dev cpy311

      - name: Build documentation
        run: just docs cpy311
